<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>BangBangPulseProblem · Piccolo.jl</title><meta name="title" content="BangBangPulseProblem · Piccolo.jl"/><meta property="og:title" content="BangBangPulseProblem · Piccolo.jl"/><meta property="twitter:title" content="BangBangPulseProblem · Piccolo.jl"/><meta name="description" content="Documentation for Piccolo.jl."/><meta property="og:description" content="Documentation for Piccolo.jl."/><meta property="twitter:description" content="Documentation for Piccolo.jl."/><meta property="og:url" content="https://docs.harmoniqs.co/Piccolo.jl/generated/problem-templates/bang_bang_pulse/"/><meta property="twitter:url" content="https://docs.harmoniqs.co/Piccolo.jl/generated/problem-templates/bang_bang_pulse/"/><link rel="canonical" href="https://docs.harmoniqs.co/Piccolo.jl/generated/problem-templates/bang_bang_pulse/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img class="docs-light-only" src="../../../assets/logo.svg" alt="Piccolo.jl logo"/><img class="docs-dark-only" src="../../../assets/logo-dark.svg" alt="Piccolo.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Piccolo.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../getting-started/installation/">Installation</a></li><li><a class="tocitem" href="../../quickstart/">Quickstart</a></li></ul></li><li><span class="tocitem">Concepts</span><ul><li><a class="tocitem" href="../../../concepts/">Overview</a></li><li><a class="tocitem" href="../../concepts/trajectories/">Trajectories</a></li><li><a class="tocitem" href="../../concepts/pulses/">Pulses</a></li><li><a class="tocitem" href="../../concepts/objectives/">Objectives</a></li><li><a class="tocitem" href="../../concepts/constraints/">Constraints</a></li><li><a class="tocitem" href="../../concepts/operators/">Operators</a></li><li><a class="tocitem" href="../../concepts/isomorphisms/">Isomorphisms</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../tutorials/">Overview</a></li><li><a class="tocitem" href="../../first_gate/">Your First Gate</a></li><li><a class="tocitem" href="../../multilevel_transmon/">Multilevel Transmon</a></li><li><a class="tocitem" href="../../state_transfer/">State Transfer</a></li><li><a class="tocitem" href="../../robust_control/">Robust Control</a></li></ul></li><li><span class="tocitem">Problem Templates</span><ul><li><a class="tocitem" href="../../../problem-templates/">Overview</a></li><li><a class="tocitem" href="../smooth_pulse/">SmoothPulseProblem</a></li><li class="is-active"><a class="tocitem" href>BangBangPulseProblem</a><ul class="internal"><li><a class="tocitem" href="#When-to-Use"><span>When to Use</span></a></li><li><a class="tocitem" href="#Comparison-with-SmoothPulseProblem"><span>Comparison with SmoothPulseProblem</span></a></li><li><a class="tocitem" href="#How-the-L1-Penalty-Works"><span>How the L1 Penalty Works</span></a></li><li><a class="tocitem" href="#Pulse-Requirement"><span>Pulse Requirement</span></a></li><li><a class="tocitem" href="#Constructor"><span>Constructor</span></a></li><li><a class="tocitem" href="#Parameter-Reference"><span>Parameter Reference</span></a></li><li><a class="tocitem" href="#Examples"><span>Examples</span></a></li><li><a class="tocitem" href="#Visualize-unitary-populations"><span>Visualize unitary populations</span></a></li><li><a class="tocitem" href="#Minimum-Time"><span>Minimum Time</span></a></li><li><a class="tocitem" href="#How-It-Works"><span>How It Works</span></a></li><li><a class="tocitem" href="#See-Also"><span>See Also</span></a></li></ul></li><li><a class="tocitem" href="../spline_pulse/">SplinePulseProblem</a></li><li><a class="tocitem" href="../minimum_time/">MinimumTimeProblem</a></li><li><a class="tocitem" href="../sampling/">SamplingProblem</a></li><li><a class="tocitem" href="../composition/">Composing Templates</a></li></ul></li><li><span class="tocitem">Quantum Systems</span><ul><li><a class="tocitem" href="../../../systems/">Overview</a></li><li><a class="tocitem" href="../../systems/transmons/">Transmon Qubits</a></li><li><a class="tocitem" href="../../systems/trapped_ions/">Trapped Ions</a></li><li><a class="tocitem" href="../../systems/rydberg_atoms/">Rydberg Atoms</a></li><li><a class="tocitem" href="../../systems/cat_qubits/">Cat Qubits</a></li><li><a class="tocitem" href="../../systems/silicon_spins/">Silicon Spins</a></li></ul></li><li><span class="tocitem">How-To Guides</span><ul><li><a class="tocitem" href="../../../guides/">Overview</a></li><li><a class="tocitem" href="../../guides/leakage_suppression/">Leakage Suppression</a></li><li><a class="tocitem" href="../../guides/global_variables/">Global Variables</a></li><li><a class="tocitem" href="../../guides/visualization/">Visualization</a></li><li><a class="tocitem" href="../../guides/custom_objectives/">Custom Objectives</a></li></ul></li><li><span class="tocitem">API Reference</span><ul><li><a class="tocitem" href="../../../reference/">Overview</a></li><li><a class="tocitem" href="../../../lib/">Library</a></li></ul></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../development/contributing/">Contributing</a></li><li><a class="tocitem" href="../../../development/release-notes/">Release Notes</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Problem Templates</a></li><li class="is-active"><a href>BangBangPulseProblem</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>BangBangPulseProblem</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/harmoniqs/Piccolo.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/harmoniqs/Piccolo.jl/blob/main/docs/literate/problem-templates/bang_bang_pulse.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="bang-bang-pulse"><a class="docs-heading-anchor" href="#bang-bang-pulse">BangBangPulseProblem</a><a id="bang-bang-pulse-1"></a><a class="docs-heading-anchor-permalink" href="#bang-bang-pulse" title="Permalink"></a></h1><p><code>BangBangPulseProblem</code> promotes <strong>bang-bang</strong> (piecewise-constant, few-switch) controls by penalizing <span>$\|du\|_1$</span> via an <strong>exact slack reformulation</strong>. Unlike <code>SmoothPulseProblem</code> (which uses 2 derivative levels with L2 regularization), this stores only 1 derivative (<code>du</code>) and uses slack variables to impose an exact L1 penalty, promoting sparsity in <code>du</code> and thus fewer switches.</p><h2 id="When-to-Use"><a class="docs-heading-anchor" href="#When-to-Use">When to Use</a><a id="When-to-Use-1"></a><a class="docs-heading-anchor-permalink" href="#When-to-Use" title="Permalink"></a></h2><p>Use <code>BangBangPulseProblem</code> when:</p><ul><li>You want piecewise constant control pulses with minimal switching</li><li>You want to promote bang-bang style controls (long constant segments)</li><li>You prefer exact L1 regularization over smooth L2 approximations</li></ul><h2 id="Comparison-with-SmoothPulseProblem"><a class="docs-heading-anchor" href="#Comparison-with-SmoothPulseProblem">Comparison with SmoothPulseProblem</a><a id="Comparison-with-SmoothPulseProblem-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison-with-SmoothPulseProblem" title="Permalink"></a></h2><table><tr><th style="text-align: right"></th><th style="text-align: right">SmoothPulseProblem</th><th style="text-align: right">BangBangPulseProblem</th></tr><tr><td style="text-align: right">Derivatives stored</td><td style="text-align: right"><code>du</code>, <code>ddu</code></td><td style="text-align: right"><code>du</code> only</td></tr><tr><td style="text-align: right">Regularization on <code>du</code></td><td style="text-align: right">L2 (<code>QuadraticRegularizer</code>)</td><td style="text-align: right">L1 (<code>LinearRegularizer</code> on slacks)</td></tr><tr><td style="text-align: right">Regularization on <code>u</code></td><td style="text-align: right">L2</td><td style="text-align: right">L2 (same)</td></tr><tr><td style="text-align: right">Extra variables</td><td style="text-align: right">—</td><td style="text-align: right">slack <code>s_du ≥ 0</code></td></tr><tr><td style="text-align: right">Extra constraints</td><td style="text-align: right">—</td><td style="text-align: right"><code>L1SlackConstraint</code>: <span>$|du| \leq s$</span></td></tr><tr><td style="text-align: right">Bound params</td><td style="text-align: right"><code>du_bound</code>, <code>ddu_bound</code></td><td style="text-align: right"><code>du_bound</code> only</td></tr></table><h2 id="How-the-L1-Penalty-Works"><a class="docs-heading-anchor" href="#How-the-L1-Penalty-Works">How the L1 Penalty Works</a><a id="How-the-L1-Penalty-Works-1"></a><a class="docs-heading-anchor-permalink" href="#How-the-L1-Penalty-Works" title="Permalink"></a></h2><p>Instead of a smooth approximation, the L1 penalty uses an exact slack reformulation. Slack variables <span>$s \geq 0$</span> (same dimension as <code>du</code>) are introduced with the constraint:</p><p class="math-container">\[|du_{k,i}| \leq s_{k,i}\]</p><p>Then the linear cost <span>$R_{du} \sum_k \sum_i s_{k,i} \Delta t_k$</span> is minimized. At optimality, <span>$s = |du|$</span>, giving the exact L1 norm.</p><h2 id="Pulse-Requirement"><a class="docs-heading-anchor" href="#Pulse-Requirement">Pulse Requirement</a><a id="Pulse-Requirement-1"></a><a class="docs-heading-anchor-permalink" href="#Pulse-Requirement" title="Permalink"></a></h2><p><code>BangBangPulseProblem</code> requires a trajectory with a <code>ZeroOrderPulse</code>:</p><pre><code class="language-julia hljs">pulse = ZeroOrderPulse(controls, times)
qtraj = UnitaryTrajectory(sys, pulse, U_goal)
qcp = BangBangPulseProblem(qtraj, N)  # Works</code></pre><p>Using a spline pulse will result in an error directing you to <code>SplinePulseProblem</code>.</p><h2 id="Constructor"><a class="docs-heading-anchor" href="#Constructor">Constructor</a><a id="Constructor-1"></a><a class="docs-heading-anchor-permalink" href="#Constructor" title="Permalink"></a></h2><pre><code class="language-julia hljs">BangBangPulseProblem(
    qtraj::AbstractQuantumTrajectory{&lt;:ZeroOrderPulse},
    N::Int;
    kwargs...
)</code></pre><h2 id="Parameter-Reference"><a class="docs-heading-anchor" href="#Parameter-Reference">Parameter Reference</a><a id="Parameter-Reference-1"></a><a class="docs-heading-anchor-permalink" href="#Parameter-Reference" title="Permalink"></a></h2><h3 id="Required-Parameters"><a class="docs-heading-anchor" href="#Required-Parameters">Required Parameters</a><a id="Required-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Required-Parameters" title="Permalink"></a></h3><table><tr><th style="text-align: right">Parameter</th><th style="text-align: right">Type</th><th style="text-align: right">Description</th></tr><tr><td style="text-align: right"><code>qtraj</code></td><td style="text-align: right"><code>AbstractQuantumTrajectory{ZeroOrderPulse}</code></td><td style="text-align: right">Quantum trajectory containing system, pulse, and goal</td></tr><tr><td style="text-align: right"><code>N</code></td><td style="text-align: right"><code>Int</code></td><td style="text-align: right">Number of discretization timesteps</td></tr></table><h3 id="Objective-Weights"><a class="docs-heading-anchor" href="#Objective-Weights">Objective Weights</a><a id="Objective-Weights-1"></a><a class="docs-heading-anchor-permalink" href="#Objective-Weights" title="Permalink"></a></h3><table><tr><th style="text-align: right">Parameter</th><th style="text-align: right">Type</th><th style="text-align: right">Default</th><th style="text-align: right">Description</th></tr><tr><td style="text-align: right"><code>Q</code></td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right"><code>100.0</code></td><td style="text-align: right">Weight on infidelity objective. Higher values prioritize achieving target fidelity.</td></tr><tr><td style="text-align: right"><code>R</code></td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right"><code>1e-2</code></td><td style="text-align: right">Base regularization weight applied to all terms.</td></tr><tr><td style="text-align: right"><code>R_u</code></td><td style="text-align: right"><code>Float64</code> or <code>Vector{Float64}</code></td><td style="text-align: right"><code>0.0</code></td><td style="text-align: right">L2 regularization on control values. Defaults to 0 (no amplitude regularization). Can be per-drive.</td></tr><tr><td style="text-align: right"><code>R_du</code></td><td style="text-align: right"><code>Float64</code> or <code>Vector{Float64}</code></td><td style="text-align: right"><code>R</code></td><td style="text-align: right">L1 weight on first derivative (applied to slacks). Higher values produce fewer switches.</td></tr></table><h3 id="Bounds"><a class="docs-heading-anchor" href="#Bounds">Bounds</a><a id="Bounds-1"></a><a class="docs-heading-anchor-permalink" href="#Bounds" title="Permalink"></a></h3><table><tr><th style="text-align: right">Parameter</th><th style="text-align: right">Type</th><th style="text-align: right">Default</th><th style="text-align: right">Description</th></tr><tr><td style="text-align: right"><code>du_bound</code></td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right"><code>Inf</code></td><td style="text-align: right">Maximum allowed control jump between timesteps.</td></tr><tr><td style="text-align: right"><code>Δt_bounds</code></td><td style="text-align: right"><code>Tuple{Float64, Float64}</code></td><td style="text-align: right"><code>nothing</code></td><td style="text-align: right">Time-step bounds <code>(min, max)</code> for free-time optimization. Required for <code>MinimumTimeProblem</code>.</td></tr></table><h3 id="Advanced-Options"><a class="docs-heading-anchor" href="#Advanced-Options">Advanced Options</a><a id="Advanced-Options-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Options" title="Permalink"></a></h3><table><tr><th style="text-align: right">Parameter</th><th style="text-align: right">Type</th><th style="text-align: right">Default</th><th style="text-align: right">Description</th></tr><tr><td style="text-align: right"><code>integrator</code></td><td style="text-align: right"><code>AbstractIntegrator</code></td><td style="text-align: right"><code>nothing</code></td><td style="text-align: right">Custom integrator. If <code>nothing</code>, uses <code>BilinearIntegrator</code>.</td></tr><tr><td style="text-align: right"><code>global_names</code></td><td style="text-align: right"><code>Vector{Symbol}</code></td><td style="text-align: right"><code>nothing</code></td><td style="text-align: right">Names of global parameters to optimize (requires custom integrator).</td></tr><tr><td style="text-align: right"><code>global_bounds</code></td><td style="text-align: right"><code>Dict{Symbol, ...}</code></td><td style="text-align: right"><code>nothing</code></td><td style="text-align: right">Bounds on global variables. Values can be <code>Float64</code> (symmetric ±) or <code>Tuple{Float64, Float64}</code>.</td></tr><tr><td style="text-align: right"><code>constraints</code></td><td style="text-align: right"><code>Vector{AbstractConstraint}</code></td><td style="text-align: right"><code>[]</code></td><td style="text-align: right">Additional constraints to add to the problem.</td></tr><tr><td style="text-align: right"><code>piccolo_options</code></td><td style="text-align: right"><code>PiccoloOptions</code></td><td style="text-align: right"><code>PiccoloOptions()</code></td><td style="text-align: right">Solver and leakage options.</td></tr></table><h2 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h2><h3 id="Basic-Gate-Synthesis"><a class="docs-heading-anchor" href="#Basic-Gate-Synthesis">Basic Gate Synthesis</a><a id="Basic-Gate-Synthesis-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Gate-Synthesis" title="Permalink"></a></h3><pre><code class="language-julia hljs">using Piccolo
using CairoMakie

# Define system
H_drift = PAULIS[:Z]
H_drives = [PAULIS[:X], PAULIS[:Y]]
sys = QuantumSystem(H_drift, H_drives, [1.0, 1.0])

# Create trajectory
T, N = 10.0, 100
times = collect(range(0, T, length = N))
pulse = ZeroOrderPulse(0.1 * randn(2, N), times)
qtraj = UnitaryTrajectory(sys, pulse, GATES[:X])

# Solve with L1 regularization on du
qcp = BangBangPulseProblem(qtraj, N; Q = 100.0, R_du = 1.0)
cached_solve!(qcp, &quot;bang_bang_basic&quot;; max_iter = 200)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">    constructing BangBangPulseProblem for UnitaryTrajectory...
	applying timesteps_all_equal constraint: Δt
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Trajectory has timestep variable :Δt but no bounds on it.
<span class="sgr33"><span class="sgr1">│ </span></span>Adding default lower bound of 0 to prevent negative timesteps.
<span class="sgr33"><span class="sgr1">│ </span></span>
<span class="sgr33"><span class="sgr1">│ </span></span>Recommended: Add explicit bounds when creating the trajectory:
<span class="sgr33"><span class="sgr1">│ </span></span>  NamedTrajectory(...; Δt_bounds=(min, max))
<span class="sgr33"><span class="sgr1">│ </span></span>Example:
<span class="sgr33"><span class="sgr1">│ </span></span>  NamedTrajectory(qtraj, N; Δt_bounds=(1e-3, 0.5))
<span class="sgr33"><span class="sgr1">│ </span></span>
<span class="sgr33"><span class="sgr1">│ </span></span>Or use timesteps_all_equal=true in problem options to fix timesteps.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ DirectTrajOpt.Problems ~/.julia/packages/DirectTrajOpt/ctobI/src/problems.jl:66</span>

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit https://github.com/coin-or/Ipopt
******************************************************************************

This is Ipopt version 3.14.19, running with linear solver MUMPS 5.8.2.

Number of nonzeros in equality constraint Jacobian...:    32044
Number of nonzeros in inequality constraint Jacobian.:      800
Number of nonzeros in Lagrangian Hessian.............:    38584

Total number of variables............................:     1587
                     variables with only lower bounds:      300
                variables with lower and upper bounds:      988
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1188
Total number of inequality constraints...............:      400
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:      400

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  1.1982910e+02 5.56e-02 1.27e+00   0.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.2017587e+02 1.41e-04 7.92e+00  -1.3 5.12e-02   2.0 9.85e-01 1.00e+00f  1
   2  1.1990412e+02 5.07e-06 1.92e+00  -1.4 1.76e-02   1.5 9.46e-01 1.00e+00f  1
   3  1.1784573e+02 1.21e-04 1.34e+00  -1.5 1.26e-01   1.0 9.62e-01 1.00e+00f  1
   4  7.8678373e+01 5.06e-03 1.26e+01  -0.8 1.26e+00   0.6 2.68e-01 3.66e-01f  1
⋮
  42  3.2418217e+00 2.61e-08 1.45e-02  -4.0 2.90e-02    -  1.00e+00 1.00e+00h  1
  43  3.2418216e+00 1.32e-12 8.02e-05  -4.0 1.60e-04    -  1.00e+00 1.00e+00h  1
  44  3.2418216e+00 1.83e-15 1.61e-06  -4.0 3.22e-06    -  1.00e+00 1.00e+00h  1
  45  3.2418216e+00 1.10e-15 8.26e-08  -4.0 1.67e-07    -  1.00e+00 1.00e+00h  1
  46  3.2418216e+00 1.46e-15 4.35e-09  -4.0 9.05e-09    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 46

                                   (scaled)                 (unscaled)
Objective...............:   3.2418215806720534e+00    3.2418215806720534e+00
Dual infeasibility......:   4.3470809183224213e-09    4.3470809183224213e-09
Constraint violation....:   1.4571677198205180e-15    1.4571677198205180e-15
Variable bound violation:   0.0000000000000000e+00    0.0000000000000000e+00
Complementarity.........:   1.0000000000006086e-04    1.0000000000006086e-04
Overall NLP error.......:   4.3470809183224213e-09    4.3470809183224213e-09


Number of objective function evaluations             = 47
Number of objective gradient evaluations             = 47
Number of equality constraint evaluations            = 47
Number of inequality constraint evaluations          = 47
Number of equality constraint Jacobian evaluations   = 47
Number of inequality constraint Jacobian evaluations = 47
Number of Lagrangian Hessian evaluations             = 46
Total seconds in IPOPT                               = 17.252

EXIT: Optimal Solution Found.
    initializing optimizer...
        applying constraint: timesteps all equal constraint
        applying constraint: L1 slack constraint: |du| ≤ s_du
        applying constraint: initial value of Ũ⃗
        applying constraint: initial value of u
        applying constraint: final value of u
        applying constraint: bounds on Ũ⃗
        applying constraint: bounds on u
        applying constraint: bounds on du
        applying constraint: bounds on s_du
        applying constraint: bounds on Δt
        applying constraint: time consistency constraint (t_{k+1} = t_k + Δt_k)
        applying constraint: initial time t₁ = 0
<span class="sgr36"><span class="sgr1">[ Info: </span></span>Loaded cached trajectory from bang_bang_basic_43c9960.jld2</code></pre><pre><code class="language-julia hljs">fidelity(qcp)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.9998975331396764</code></pre><h2 id="Visualize-unitary-populations"><a class="docs-heading-anchor" href="#Visualize-unitary-populations">Visualize unitary populations</a><a id="Visualize-unitary-populations-1"></a><a class="docs-heading-anchor-permalink" href="#Visualize-unitary-populations" title="Permalink"></a></h2><pre><code class="language-julia hljs">traj = get_trajectory(qcp)
fig = plot_unitary_populations(traj)</code></pre><img src="372d5b2c.png" alt="Example block output"/><h2 id="Minimum-Time"><a class="docs-heading-anchor" href="#Minimum-Time">Minimum Time</a><a id="Minimum-Time-1"></a><a class="docs-heading-anchor-permalink" href="#Minimum-Time" title="Permalink"></a></h2><pre><code class="language-julia hljs">qcp_min = MinimumTimeProblem(qcp, final_fidelity = 0.99)
cached_solve!(qcp_min, &quot;bang_bang_min_time&quot;; max_iter = 300)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">    constructing MinimumTimeProblem from QuantumControlProblem{UnitaryTrajectory{ZeroOrderPulse{DataInterpolations.ConstantInterpolation{Matrix{Float64}, Vector{Float64}, Vector{Union{}}, Float64}}, SciMLBase.ODESolution{ComplexF64, 3, Vector{Matrix{ComplexF64}}, Nothing, Nothing, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, SciMLBase.ODEProblem{Matrix{ComplexF64}, Tuple{Float64, Float64}, true, SciMLBase.NullParameters, SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Base.Pairs{Symbol, Vector{Float64}, Nothing, @NamedTuple{tstops::Vector{Float64}, saveat::Vector{Float64}}}, SciMLBase.StandardODEProblem}, OrdinaryDiffEqLinear.MagnusGL4, OrdinaryDiffEqCore.InterpolationData{SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Vector{Matrix{ComplexF64}}, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, OrdinaryDiffEqLinear.MagnusGL4Cache{Matrix{ComplexF64}, Matrix{ComplexF64}, Matrix{ComplexF64}, Nothing}, Nothing}, SciMLBase.DEStats, Nothing, Nothing, Nothing, Nothing}, Matrix{ComplexF64}}}...
	final fidelity constraint: 0.99
	minimum-time weight D: 100.0
This is Ipopt version 3.14.19, running with linear solver MUMPS 5.8.2.

Number of nonzeros in equality constraint Jacobian...:    32044
Number of nonzeros in inequality constraint Jacobian.:      808
Number of nonzeros in Lagrangian Hessian.............:    38584

Total number of variables............................:     1587
                     variables with only lower bounds:      300
                variables with lower and upper bounds:      988
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1188
Total number of inequality constraints...............:      401
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:      401

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  9.3466811e+02 9.90e-03 1.65e+00   0.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  9.1269689e+02 3.96e-03 3.53e+00  -4.0 2.55e+00    -  2.29e-01 2.93e-01f  1
   2  9.0173487e+02 1.11e-02 3.70e+00  -4.0 9.50e-01   0.0 1.20e-01 2.01e-01f  1
   3  8.6220156e+02 3.15e-03 2.53e+02  -1.3 5.49e-01   0.4 2.46e-01 9.71e-01f  1
   4  8.0366696e+02 6.95e-03 1.66e+02  -1.4 1.51e+00  -0.1 2.73e-01 3.98e-01f  1
⋮
  67  2.4423265e+02 9.63e-07 1.90e+00  -4.0 3.92e+00    -  1.00e+00 1.00e+00h  1
  68  2.4423246e+02 7.15e-09 2.02e-01  -4.0 4.18e-01    -  1.00e+00 1.00e+00h  1
  69  2.4423246e+02 1.84e-13 9.69e-04  -4.0 2.00e-03    -  1.00e+00 1.00e+00h  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  70  2.4423246e+02 2.67e-16 1.15e-07  -4.0 2.40e-07    -  1.00e+00 1.00e+00h  1
  71  2.4423246e+02 2.64e-16 1.00e-09  -4.0 6.44e-12    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 71

                                   (scaled)                 (unscaled)
Objective...............:   2.3635307042079774e+02    2.4423245763408104e+02
Dual infeasibility......:   1.0017716708249358e-09    1.0351680928797638e-09
Constraint violation....:   2.6367796834847468e-16    2.6367796834847468e-16
Variable bound violation:   0.0000000000000000e+00    0.0000000000000000e+00
Complementarity.........:   1.0000000000008403e-04    1.0333373592289716e-04
Overall NLP error.......:   1.0017716708249358e-09    1.0351680928797638e-09


Number of objective function evaluations             = 72
Number of objective gradient evaluations             = 72
Number of equality constraint evaluations            = 72
Number of inequality constraint evaluations          = 72
Number of equality constraint Jacobian evaluations   = 72
Number of inequality constraint Jacobian evaluations = 72
Number of Lagrangian Hessian evaluations             = 71
Total seconds in IPOPT                               = 9.159

EXIT: Optimal Solution Found.
    initializing optimizer...
        applying constraint: timesteps all equal constraint
        applying constraint: L1 slack constraint: |du| ≤ s_du
        applying constraint: initial value of Ũ⃗
        applying constraint: initial value of u
        applying constraint: final value of u
        applying constraint: bounds on Ũ⃗
        applying constraint: bounds on u
        applying constraint: bounds on du
        applying constraint: bounds on s_du
        applying constraint: bounds on Δt
        applying constraint: time consistency constraint (t_{k+1} = t_k + Δt_k)
        applying constraint: initial time t₁ = 0
<span class="sgr36"><span class="sgr1">[ Info: </span></span>Loaded cached trajectory from bang_bang_min_time_43c9960.jld2</code></pre><pre><code class="language-julia hljs">before = get_duration(traj)
after = duration(get_pulse(qcp_min.qtraj))
before - after</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">6.922172753439191</code></pre><pre><code class="language-julia hljs">fig = plot_unitary_populations(get_trajectory(qcp_min))</code></pre><img src="c07f0a1c.png" alt="Example block output"/><h3 id="Tuning-the-L1-Weight"><a class="docs-heading-anchor" href="#Tuning-the-L1-Weight">Tuning the L1 Weight</a><a id="Tuning-the-L1-Weight-1"></a><a class="docs-heading-anchor-permalink" href="#Tuning-the-L1-Weight" title="Permalink"></a></h3><p>The <code>R_du</code> parameter controls how aggressively switches are penalized. Higher values produce fewer switches (more bang-bang):</p><pre><code class="language-julia hljs">qcp = BangBangPulseProblem(
    qtraj,
    N;
    Q = 100.0,
    R_du = 1.0,    ## Strong L1 penalty → fewer switches
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">QuantumControlProblem{UnitaryTrajectory{ZeroOrderPulse{DataInterpolations.ConstantInterpolation{Matrix{Float64}, Vector{Float64}, Vector{Union{}}, Float64}}, SciMLBase.ODESolution{ComplexF64, 3, Vector{Matrix{ComplexF64}}, Nothing, Nothing, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, SciMLBase.ODEProblem{Matrix{ComplexF64}, Tuple{Float64, Float64}, true, SciMLBase.NullParameters, SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Base.Pairs{Symbol, Vector{Float64}, Nothing, @NamedTuple{tstops::Vector{Float64}, saveat::Vector{Float64}}}, SciMLBase.StandardODEProblem}, OrdinaryDiffEqLinear.MagnusGL4, OrdinaryDiffEqCore.InterpolationData{SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Vector{Matrix{ComplexF64}}, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, OrdinaryDiffEqLinear.MagnusGL4Cache{Matrix{ComplexF64}, Matrix{ComplexF64}, Matrix{ComplexF64}, Nothing}, Nothing}, SciMLBase.DEStats, Nothing, Nothing, Nothing, Nothing}, Matrix{ComplexF64}}}
  System: QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}
  Goal: Matrix{ComplexF64}
  Trajectory: 100 knots
  State: Ũ⃗
  Controls: u</code></pre><h3 id="With-Derivative-Bounds"><a class="docs-heading-anchor" href="#With-Derivative-Bounds">With Derivative Bounds</a><a id="With-Derivative-Bounds-1"></a><a class="docs-heading-anchor-permalink" href="#With-Derivative-Bounds" title="Permalink"></a></h3><p>Constrain the maximum control jump size:</p><pre><code class="language-julia hljs">qcp = BangBangPulseProblem(
    qtraj,
    N;
    Q = 100.0,
    R_du = 1e-1,
    du_bound = 0.5,    ## Limit control jumps
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">QuantumControlProblem{UnitaryTrajectory{ZeroOrderPulse{DataInterpolations.ConstantInterpolation{Matrix{Float64}, Vector{Float64}, Vector{Union{}}, Float64}}, SciMLBase.ODESolution{ComplexF64, 3, Vector{Matrix{ComplexF64}}, Nothing, Nothing, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, SciMLBase.ODEProblem{Matrix{ComplexF64}, Tuple{Float64, Float64}, true, SciMLBase.NullParameters, SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Base.Pairs{Symbol, Vector{Float64}, Nothing, @NamedTuple{tstops::Vector{Float64}, saveat::Vector{Float64}}}, SciMLBase.StandardODEProblem}, OrdinaryDiffEqLinear.MagnusGL4, OrdinaryDiffEqCore.InterpolationData{SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Vector{Matrix{ComplexF64}}, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, OrdinaryDiffEqLinear.MagnusGL4Cache{Matrix{ComplexF64}, Matrix{ComplexF64}, Matrix{ComplexF64}, Nothing}, Nothing}, SciMLBase.DEStats, Nothing, Nothing, Nothing, Nothing}, Matrix{ComplexF64}}}
  System: QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}
  Goal: Matrix{ComplexF64}
  Trajectory: 100 knots
  State: Ũ⃗
  Controls: u</code></pre><h3 id="Per-Drive-Regularization"><a class="docs-heading-anchor" href="#Per-Drive-Regularization">Per-Drive Regularization</a><a id="Per-Drive-Regularization-1"></a><a class="docs-heading-anchor-permalink" href="#Per-Drive-Regularization" title="Permalink"></a></h3><p>Apply different L1 weights to different control channels:</p><pre><code class="language-julia hljs">qcp = BangBangPulseProblem(
    qtraj,
    N;
    Q = 100.0,
    R_u = [1e-3, 1e-2],     ## Less L2 regularization on drive 1
    R_du = [1e-1, 1.0],     ## Stronger L1 on drive 2
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">QuantumControlProblem{UnitaryTrajectory{ZeroOrderPulse{DataInterpolations.ConstantInterpolation{Matrix{Float64}, Vector{Float64}, Vector{Union{}}, Float64}}, SciMLBase.ODESolution{ComplexF64, 3, Vector{Matrix{ComplexF64}}, Nothing, Nothing, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, SciMLBase.ODEProblem{Matrix{ComplexF64}, Tuple{Float64, Float64}, true, SciMLBase.NullParameters, SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Base.Pairs{Symbol, Vector{Float64}, Nothing, @NamedTuple{tstops::Vector{Float64}, saveat::Vector{Float64}}}, SciMLBase.StandardODEProblem}, OrdinaryDiffEqLinear.MagnusGL4, OrdinaryDiffEqCore.InterpolationData{SciMLBase.ODEFunction{true, SciMLBase.FullSpecialize, SciMLOperators.MatrixOperator{ComplexF64, Matrix{ComplexF64}, SciMLOperators.FilterKwargs{Nothing, Val{()}}, SciMLOperators.FilterKwargs{Piccolo.Quantum.Rollouts.var&quot;#update!#_construct_operator##2&quot;{QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}}, Val{()}}}, LinearAlgebra.UniformScaling{Bool}, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED), Nothing, Piccolo.Quantum.Rollouts.PiccoloRolloutSystem{Union{Int64, AbstractVector{Int64}, CartesianIndex, CartesianIndices}}, Nothing, Nothing}, Vector{Matrix{ComplexF64}}, Vector{Float64}, Vector{Vector{Matrix{ComplexF64}}}, Nothing, OrdinaryDiffEqLinear.MagnusGL4Cache{Matrix{ComplexF64}, Matrix{ComplexF64}, Matrix{ComplexF64}, Nothing}, Nothing}, SciMLBase.DEStats, Nothing, Nothing, Nothing, Nothing}, Matrix{ComplexF64}}}
  System: QuantumSystem{Piccolo.Quantum.QuantumSystems.var&quot;#32#33&quot;{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}, Vector{SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}, Int64}, Piccolo.Quantum.QuantumSystems.var&quot;#34#35&quot;{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, Int64, SparseArrays.SparseMatrixCSC{Float64, Int64}}, @NamedTuple{}}
  Goal: Matrix{ComplexF64}
  Trajectory: 100 knots
  State: Ũ⃗
  Controls: u</code></pre><h3 id="State-Transfer"><a class="docs-heading-anchor" href="#State-Transfer">State Transfer</a><a id="State-Transfer-1"></a><a class="docs-heading-anchor-permalink" href="#State-Transfer" title="Permalink"></a></h3><pre><code class="language-julia hljs">ψ_init = ComplexF64[1, 0]  ## |0⟩
ψ_goal = ComplexF64[0, 1]  ## |1⟩

pulse = ZeroOrderPulse(0.1 * randn(2, N), times)
qtraj = KetTrajectory(sys, pulse, ψ_init, ψ_goal)

qcp = BangBangPulseProblem(qtraj, N; Q = 100.0, R_du = 1.0)
cached_solve!(qcp, &quot;bang_bang_state_transfer&quot;; max_iter = 100)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">    constructing BangBangPulseProblem for KetTrajectory...
	applying timesteps_all_equal constraint: Δt
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Trajectory has timestep variable :Δt but no bounds on it.
<span class="sgr33"><span class="sgr1">│ </span></span>Adding default lower bound of 0 to prevent negative timesteps.
<span class="sgr33"><span class="sgr1">│ </span></span>
<span class="sgr33"><span class="sgr1">│ </span></span>Recommended: Add explicit bounds when creating the trajectory:
<span class="sgr33"><span class="sgr1">│ </span></span>  NamedTrajectory(...; Δt_bounds=(min, max))
<span class="sgr33"><span class="sgr1">│ </span></span>Example:
<span class="sgr33"><span class="sgr1">│ </span></span>  NamedTrajectory(qtraj, N; Δt_bounds=(1e-3, 0.5))
<span class="sgr33"><span class="sgr1">│ </span></span>
<span class="sgr33"><span class="sgr1">│ </span></span>Or use timesteps_all_equal=true in problem options to fix timesteps.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ DirectTrajOpt.Problems ~/.julia/packages/DirectTrajOpt/ctobI/src/problems.jl:66</span>
This is Ipopt version 3.14.19, running with linear solver MUMPS 5.8.2.

Number of nonzeros in equality constraint Jacobian...:    14696
Number of nonzeros in inequality constraint Jacobian.:      800
Number of nonzeros in Lagrangian Hessian.............:    21862

Total number of variables............................:     1191
                     variables with only lower bounds:      300
                variables with lower and upper bounds:      592
                     variables with only upper bounds:        0
Total number of equality constraints.................:      792
Total number of inequality constraints...............:      400
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:      400

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  1.1195048e+02 1.96e-01 1.80e+00   0.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.1020739e+02 7.07e-02 2.38e+01  -0.9 1.83e-01   2.0 9.30e-01 6.39e-01f  1
   2  1.0550439e+02 4.69e-04 1.25e+01  -0.7 7.48e-02   1.5 9.81e-01 1.00e+00f  1
   3  8.2050156e+01 1.29e-03 7.78e+00  -0.7 2.36e-01   1.0 7.23e-01 1.00e+00f  1
   4  2.6132752e+01 4.26e-03 3.84e+02  -0.8 5.52e-01   0.6 5.98e-01 6.84e-01f  1
⋮
  96  1.0141346e+01 1.15e-05 2.64e-01  -4.0 3.73e-01  -0.9 1.00e+00 2.32e-01f  1
  97  9.7367060e+00 2.42e-05 2.91e+02  -3.7 1.11e+00  -1.4 1.00e+00 1.22e-01f  1
  98  9.0073341e+00 1.70e-04 3.33e+01  -2.7 3.06e+00  -1.8 8.32e-01 1.14e-01f  1
  99  8.9369477e+00 4.15e-07 1.13e-01  -4.0 1.90e-02   0.4 1.00e+00 1.00e+00h  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
 100  8.7780124e+00 1.50e-06 5.50e-02  -4.0 5.84e-02  -0.1 1.00e+00 8.50e-01f  1

Number of Iterations....: 100

                                   (scaled)                 (unscaled)
Objective...............:   8.7780124132994928e+00    8.7780124132994928e+00
Dual infeasibility......:   5.5021038885013897e-02    5.5021038885013897e-02
Constraint violation....:   1.4963190144968129e-06    1.4963190144968129e-06
Variable bound violation:   0.0000000000000000e+00    0.0000000000000000e+00
Complementarity.........:   1.4939958657379462e-04    1.4939958657379462e-04
Overall NLP error.......:   5.5021038885013897e-02    5.5021038885013897e-02


Number of objective function evaluations             = 102
Number of objective gradient evaluations             = 101
Number of equality constraint evaluations            = 102
Number of inequality constraint evaluations          = 102
Number of equality constraint Jacobian evaluations   = 101
Number of inequality constraint Jacobian evaluations = 101
Number of Lagrangian Hessian evaluations             = 100
Total seconds in IPOPT                               = 12.687

EXIT: Maximum Number of Iterations Exceeded.
    initializing optimizer...
        applying constraint: timesteps all equal constraint
        applying constraint: L1 slack constraint: |du| ≤ s_du
        applying constraint: initial value of ψ̃
        applying constraint: initial value of u
        applying constraint: final value of u
        applying constraint: bounds on ψ̃
        applying constraint: bounds on u
        applying constraint: bounds on du
        applying constraint: bounds on s_du
        applying constraint: bounds on Δt
        applying constraint: time consistency constraint (t_{k+1} = t_k + Δt_k)
        applying constraint: initial time t₁ = 0
<span class="sgr36"><span class="sgr1">[ Info: </span></span>Loaded cached trajectory from bang_bang_state_transfer_43c9960.jld2</code></pre><h3 id="Multiple-State-Transfers"><a class="docs-heading-anchor" href="#Multiple-State-Transfers">Multiple State Transfers</a><a id="Multiple-State-Transfers-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-State-Transfers" title="Permalink"></a></h3><p>Use <code>MultiKetTrajectory</code> for gates defined by state mappings:</p><pre><code class="language-julia hljs">ψ0, ψ1 = ComplexF64[1, 0], ComplexF64[0, 1]

# X gate: |0⟩ → |1⟩ and |1⟩ → |0⟩
pulse = ZeroOrderPulse(0.1 * randn(2, N), times)
qtraj = MultiKetTrajectory(sys, pulse, [ψ0, ψ1], [ψ1, ψ0])

qcp = BangBangPulseProblem(qtraj, N; Q = 100.0, R_du = 1.0)
cached_solve!(qcp, &quot;bang_bang_multi_ket&quot;; max_iter = 100)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">    constructing BangBangPulseProblem for MultiKetTrajectory (2 states)...
	applying timesteps_all_equal constraint: Δt
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Trajectory has timestep variable :Δt but no bounds on it.
<span class="sgr33"><span class="sgr1">│ </span></span>Adding default lower bound of 0 to prevent negative timesteps.
<span class="sgr33"><span class="sgr1">│ </span></span>
<span class="sgr33"><span class="sgr1">│ </span></span>Recommended: Add explicit bounds when creating the trajectory:
<span class="sgr33"><span class="sgr1">│ </span></span>  NamedTrajectory(...; Δt_bounds=(min, max))
<span class="sgr33"><span class="sgr1">│ </span></span>Example:
<span class="sgr33"><span class="sgr1">│ </span></span>  NamedTrajectory(qtraj, N; Δt_bounds=(1e-3, 0.5))
<span class="sgr33"><span class="sgr1">│ </span></span>
<span class="sgr33"><span class="sgr1">│ </span></span>Or use timesteps_all_equal=true in problem options to fix timesteps.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ DirectTrajOpt.Problems ~/.julia/packages/DirectTrajOpt/ctobI/src/problems.jl:66</span>
This is Ipopt version 3.14.19, running with linear solver MUMPS 5.8.2.

Number of nonzeros in equality constraint Jacobian...:    32044
Number of nonzeros in inequality constraint Jacobian.:      800
Number of nonzeros in Lagrangian Hessian.............:    38584

Total number of variables............................:     1587
                     variables with only lower bounds:      300
                variables with lower and upper bounds:      988
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1188
Total number of inequality constraints...............:      400
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:      400

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  1.2415350e+02 1.21e-01 1.22e+00   0.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.2433806e+02 7.79e-02 1.40e+01  -0.9 1.46e-01   2.0 9.91e-01 3.56e-01f  1
   2  1.2428881e+02 2.91e-04 1.47e+01  -0.6 1.68e-01   1.5 1.00e+00 1.00e+00f  1
   3  1.2162207e+02 1.66e-04 7.89e+00  -1.1 8.71e-02   1.0 8.98e-01 1.00e+00f  1
   4  3.1028769e+01 1.59e-02 4.58e+01  -0.4 1.36e+00   0.6 5.51e-01 5.71e-01f  1
⋮
  96  3.3005075e+00 5.03e-10 1.75e-03  -4.1 3.50e-03    -  1.00e+00 1.00e+00h  1
  97  3.3119512e+00 8.81e-06 2.98e-01  -4.0 5.99e-01    -  1.00e+00 1.00e+00f  1
  98  3.3004798e+00 1.43e-05 3.16e-01  -4.1 6.34e-01    -  1.00e+00 1.00e+00h  1
  99  3.3005148e+00 1.17e-06 8.52e-02  -4.1 1.70e-01    -  1.00e+00 1.00e+00h  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
 100  3.3005083e+00 8.36e-09 5.34e-03  -4.1 1.07e-02    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 100

                                   (scaled)                 (unscaled)
Objective...............:   3.3005082649344404e+00    3.3005082649344404e+00
Dual infeasibility......:   5.3405531927499883e-03    5.3405531927499883e-03
Constraint violation....:   8.3626945646120276e-09    8.3626945646120276e-09
Variable bound violation:   0.0000000000000000e+00    0.0000000000000000e+00
Complementarity.........:   7.9998953223595626e-05    7.9998953223595626e-05
Overall NLP error.......:   5.3405531927499883e-03    5.3405531927499883e-03


Number of objective function evaluations             = 131
Number of objective gradient evaluations             = 101
Number of equality constraint evaluations            = 131
Number of inequality constraint evaluations          = 131
Number of equality constraint Jacobian evaluations   = 101
Number of inequality constraint Jacobian evaluations = 101
Number of Lagrangian Hessian evaluations             = 100
Total seconds in IPOPT                               = 22.596

EXIT: Maximum Number of Iterations Exceeded.
    initializing optimizer...
        applying constraint: timesteps all equal constraint
        applying constraint: L1 slack constraint: |du| ≤ s_du
        applying constraint: initial value of ψ̃1
        applying constraint: initial value of ψ̃2
        applying constraint: initial value of u
        applying constraint: final value of u
        applying constraint: bounds on ψ̃1
        applying constraint: bounds on ψ̃2
        applying constraint: bounds on u
        applying constraint: bounds on du
        applying constraint: bounds on s_du
        applying constraint: bounds on Δt
        applying constraint: time consistency constraint (t_{k+1} = t_k + Δt_k)
        applying constraint: initial time t₁ = 0
<span class="sgr36"><span class="sgr1">[ Info: </span></span>Loaded cached trajectory from bang_bang_multi_ket_43c9960.jld2</code></pre><h2 id="How-It-Works"><a class="docs-heading-anchor" href="#How-It-Works">How It Works</a><a id="How-It-Works-1"></a><a class="docs-heading-anchor-permalink" href="#How-It-Works" title="Permalink"></a></h2><p><code>BangBangPulseProblem</code> internally:</p><ol><li><p><strong>Adds 1 derivative variable</strong>: Creates <code>:du</code> (first derivative) alongside controls <code>:u</code> (compared to 2 in <code>SmoothPulseProblem</code>)</p></li><li><p><strong>Adds slack variables</strong>: Creates <code>:s_du</code> (non-negative, same dimension as <code>:du</code>), initialized at <code>|du|</code></p></li><li><p><strong>Sets up integrators</strong>: Uses <code>DerivativeIntegrator</code> to enforce:</p><ul><li><code>du[k] = (u[k+1] - u[k]) / Δt</code></li></ul></li><li><p><strong>Configures objectives</strong>:</p><ul><li>Infidelity objective with weight <code>Q</code></li><li>Quadratic (L2) regularization on <code>u</code> with weight <code>R_u</code></li><li>Linear (L1) regularization on <code>s_du</code> with weight <code>R_du</code></li></ul></li><li><p><strong>Applies constraints</strong>: <code>L1SlackConstraint</code> enforces <code>|du| ≤ s_du</code>, and <code>du_bound</code> as hard constraints</p></li></ol><p>At optimality the slacks satisfy <code>s = |du|</code>, so the linear cost on <code>s</code> equals the exact L1 norm of <code>du</code>.</p><h2 id="See-Also"><a class="docs-heading-anchor" href="#See-Also">See Also</a><a id="See-Also-1"></a><a class="docs-heading-anchor-permalink" href="#See-Also" title="Permalink"></a></h2><ul><li><a href="../smooth_pulse/#smooth-pulse">SmoothPulseProblem</a> - For smooth (L2-regularized) controls</li><li><a href="../spline_pulse/#spline-pulse">SplinePulseProblem</a> - For inherently smooth spline-based controls</li><li><a href="../minimum_time/#minimum-time">MinimumTimeProblem</a> - Time-optimal control</li></ul><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../smooth_pulse/">« SmoothPulseProblem</a><a class="docs-footer-nextpage" href="../spline_pulse/">SplinePulseProblem »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.17.0 on <span class="colophon-date" title="Saturday 28 February 2026 05:34">Saturday 28 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
